<annotation id="a{{ annotation.id }}">
    <div class="annotation_head">
        <sup>
            <a href="{{ url_for("annotation",
                    annotation_id=annotation.id) }}">
                [{{ annotation.id }}]
            </a>
        </sup>

        on
        <em>
            <a href="{{ annotation.HEAD.lines[0].get_url() }}#{{ annotation.HEAD.first_line_num }}">
                {%- if annotation.HEAD.first_line_num ==
                        annotation.HEAD.last_line_num %}
                    l.{{ annotation.HEAD.last_line_num }}
                {% else -%}
                    ll.{{ annotation.HEAD.first_line_num }}-{{ annotation.HEAD.last_line_num }}
                {% endif -%}
            </a>
        </em>
        of
        <em>
            <a href="{{ url_for("book", book_url=annotation.book.url) }}">
                {{ annotation.book.title }}
            </a>
        </em>
        by
        <a href="{{ url_for("author", name=annotation.book.author.url) }}">
            {{ annotation.book.author.name }}
        </a>

        <!--Weight-->
        {% if annotation.weight > 0 -%}
            {%- if annotation.weight >= 1000000 -%}
                <weight class="up">
                    {{ round(annotation.weight / 1000000, 1) }}m
                </weight>
            {%- elif annotation.weight >= 1000 -%}
                <weight class="up">
                    {{ round(annotation.weight / 1000, 1) }}k
                </weight>
            {%- else -%}
                <weight class="up">
                    {{ annotation.weight }}
                </weight>
            {%- endif -%}

        {%- elif annotation.weight == 0 -%}
            <weight class="nil">
                {{ annotation.weight }}
            </weight>
        {%- else -%}
            {%- if annotation.weight <= -1000000 -%}
                <weight class="down">
                    {{ round(annotation.weight / 1000000, 1) }}m
                </weight>
            {%- elif annotation.weight <= -1000 -%}
                <weight class="down">
                    {{ round(annotation.weight / 1000, 1) }}k
                </weight>
            {%- else -%}
            <weight class="down">
                {{ annotation.weight }}
            </weight>
            {%- endif -%}
        {%- endif -%}

        {% if annotation.locked %}
            ðŸ”’
        {% endif %}
    </div>

    <div class="annotation_content">
        {%- if len(annotation.HEAD.annotation) < 255 -%}
        {{ annotation.HEAD.annotation|markdown }}
        {%- else -%}
        <span class="cutoff">
            {{ annotation.HEAD.annotation[:255]|markdown }}
        </span>
        <a href="{{ url_for("annotation", annotation_id=annotation.id) }}">
            View More
        </a>
        {%- endif -%}
    </div>

    <tags>
        {% for t in annotation.HEAD.tags %}
            <a href="{{ url_for("tag", tag=t.tag) }}">
                <tag>{{ t.tag }}</tag>
            </a>
        {% endfor %}
    </tags>

    <br>

    {%- if annotation.HEAD.previous_id == None %}
        annotated by
        <a href="{{ url_for("user", user_id=annotation.author.id) }}">
            {{ annotation.author.displayname }}
        </a>
        {% include "/includes/_reputation_author.html" %}
    {%- else -%}
        <a href="{{ url_for("edit_history", annotation_id=annotation.id) }}">
            last edited
        </a>
        by
        <a href="{{ url_for("user", user_id=annotation.HEAD.editor.id) }}">
            {{ annotation.HEAD.editor.displayname }}
        </a>
        {% include "/includes/_reputation_editor.html" %}
    {% endif %}

    {{ annotation.added }}

    |

    {% if uservotes and annotation.id in uservotes and uservotes[annotation.id] %}
        <a href="{{ url_for("upvote", anno_id=annotation.id,
                next=request.full_path) }}" class="voted">
            up
        </a>
    {% else %}
        <a href="{{ url_for("upvote", anno_id=annotation.id,
                next=request.full_path) }}" class="notvoted">
            up
        </a>
    {% endif -%}

    /

    {%- if uservotes and annotation.id in uservotes and
            not uservotes[annotation.id] %}
        <a href="{{ url_for("downvote", anno_id=annotation.id,
                next=request.full_path) }}" class="voted">
            down
        </a>
    {% else %}
        <a href="{{ url_for("downvote", anno_id=annotation.id,
                next=request.full_path) }}" class="notvoted">
            down
        </a>
    {% endif -%}
    |
    <div class="dropdown">
        <a class="dropbtn">flag&#x25be;</a>
        <div class="dropdown-content">
            {% for annotationflag in annotationflags %}
                <a href="{{ url_for("flag_annotation",
                        flag_id=annotationflag.id, annotation_id=annotation.id,
                        next=request.full_path) }}">
                    {{ annotationflag.flag }}
                </a>
            {% endfor %}
        </div>
    </div>

    {% if current_user != annotation.author %}
    |
    {% if current_user.is_authenticated and annotation in current_user.followed_annotations %}
    <a href="{{ url_for("follow_annotation", annotation_id=annotation.id, next=request.full_path ) }}">
        unfollow
    </a>
    {% else %}
    <a href="{{ url_for("follow_annotation", annotation_id=annotation.id, next=request.full_path ) }}">
        follow
    </a>
    {% endif %}
    {% endif %}

    {% if current_user.is_authenticated and
            (current_user.has_right("edit_locked_annotations")
                    or not annotation.locked) %}
        |
        <a href="{{ url_for("edit", anno_id=annotation.id,
                next=request.full_path) }}">
            edit
        </a>
    {% endif %}

    {% if current_user.is_authenticated and
            current_user.has_right("delete_annotations") %}
        |
        {% if annotation.active %}
            <a href="{{ url_for("delete", anno_id=annotation.id,
                    next=request.full_path) }}">
                delete
            </a>
        {% else %}
            <a href="{{ url_for("delete", anno_id=annotation.id,
                    next=request.full_path) }}">
                undelete
            </a>
        {% endif %}
    {% endif %}
</annotation>
